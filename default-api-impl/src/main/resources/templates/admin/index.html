<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DV Config Admin</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/element-plus/2.4.4/index.css" />
    <!-- Font Awesome -->
    <link href="https://cdn.staticfile.org/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f5f7fa; }
        .el-header { background-color: #343a40; color: #fff; line-height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        .logo { font-size: 20px; font-weight: bold; text-decoration: none; color: #fff; display: flex; align-items: center; }
        .nav-menu { border-bottom: none !important; background-color: transparent !important; flex: 1; margin-left: 20px; }
        .nav-menu .el-menu-item { color: #ccc !important; }
        .nav-menu .el-menu-item.is-active { color: #fff !important; border-bottom: 2px solid #409EFF !important; background-color: transparent !important; }
        .nav-menu .el-menu-item:hover { background-color: rgba(255,255,255,0.1) !important; color: #fff !important; }
        .main-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .el-card { margin-bottom: 20px; }

        /* Diff Styles */
        .diff-card { margin-bottom: 20px; border: 1px solid #ebeef5; border-radius: 4px; overflow: hidden; }
        .diff-header { padding: 10px 15px; background-color: #f5f7fa; border-bottom: 1px solid #ebeef5; display: flex; justify-content: space-between; align-items: center; }
        .diff-content { display: flex; }
        .diff-pane { flex: 1; padding: 15px; font-family: monospace; white-space: pre-wrap; word-break: break-all; font-size: 13px; }
        .diff-pane.old { background-color: #fef0f0; color: #f56c6c; border-right: 1px solid #ebeef5; }
        .diff-pane.new { background-color: #f0f9eb; color: #67c23a; }
        .diff-pane.empty { background-color: #fafafa; color: #909399; }
        .diff-label { font-size: 12px; color: #909399; margin-bottom: 5px; text-transform: uppercase; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <el-container>
        <el-header>
            <div class="logo"><i class="fas fa-cogs me-2"></i>DV Config</div>
            <el-menu mode="horizontal" :default-active="activeRoute" class="nav-menu" router>
                <el-menu-item index="/admin/config"><i class="fas fa-list me-1"></i>Config</el-menu-item>
                <el-menu-item index="/admin/config/drafts"><i class="fas fa-edit me-1"></i>Config Drafts</el-menu-item>
                <el-menu-item index="/admin/config/history"><i class="fas fa-history me-1"></i>Config History</el-menu-item>
                <el-menu-item index="/admin/route"><i class="fas fa-route me-1"></i>Route</el-menu-item>
                <el-menu-item index="/admin/route/drafts"><i class="fas fa-edit me-1"></i>Route Drafts</el-menu-item>
                <el-menu-item index="/admin/route/history"><i class="fas fa-history me-1"></i>Route History</el-menu-item>
            </el-menu>
        </el-header>
        <el-main class="main-container">
            <router-view></router-view>
        </el-main>
    </el-container>
</div>

<!-- Vue 3 -->
<script src="https://cdn.staticfile.org/vue/3.3.4/vue.global.prod.min.js"></script>
<!-- Vue Router -->
<script src="https://cdn.staticfile.org/vue-router/4.2.4/vue-router.global.prod.min.js"></script>
<!-- Element Plus -->
<script src="https://cdn.staticfile.org/element-plus/2.4.4/index.full.min.js"></script>
<!-- Axios -->
<script src="https://cdn.staticfile.org/axios/1.6.2/axios.min.js"></script>

<script>
    const { createApp, ref, reactive, onMounted, computed } = Vue;
    const { createRouter, createWebHistory, useRouter } = VueRouter;
    const { ElMessage, ElMessageBox } = ElementPlus;

    // Axios Interceptor for Global Response Handling
    axios.interceptors.response.use(
        response => {
            const res = response.data;
            // If response follows IResponse structure
            if (res && typeof res.success === 'boolean') {
                if (res.success) {
                    return res.data; // Return the actual data
                } else {
                    return Promise.reject(new Error(res.message || 'Error'));
                }
            }
            return res; // Fallback for non-standard responses
        },
        error => {
            const message = error.response?.data?.message || error.message || 'Network Error';
            return Promise.reject(new Error(message));
        }
    );

    // --- Components ---

    // Config List Component
    const ConfigList = {
        template: `
            <div>
                <div class="page-header">
                    <h2><i class="fas fa-list-alt me-2 text-primary"></i>Configuration List</h2>
                    <div class="actions">
                        <el-input v-model="keyword" placeholder="Search..." style="width: 200px; margin-right: 10px;" @keyup.enter="fetchData" clearable @clear="fetchData">
                            <template #append>
                                <el-button @click="fetchData"><i class="fas fa-search"></i></el-button>
                            </template>
                        </el-input>
                        <el-button type="primary" @click="openAddModal"><i class="fas fa-plus me-1"></i>Batch Add / Modify</el-button>
                        <el-button type="danger" v-if="selectedRows.length > 0" @click="batchDelete"><i class="fas fa-trash me-1"></i>Batch Delete</el-button>
                    </div>
                </div>

                <el-card>
                    <el-table :data="tableData" style="width: 100%" @selection-change="handleSelectionChange" v-loading="loading">
                        <el-table-column type="selection" width="55"></el-table-column>
                        <el-table-column prop="id" label="ID" width="80"></el-table-column>
                        <el-table-column prop="namespace" label="Namespace">
                            <template #default="scope"><el-tag>{{ scope.row.namespace }}</el-tag></template>
                        </el-table-column>
                        <el-table-column prop="key" label="Key" class-name="fw-bold"></el-table-column>
                        <el-table-column prop="value" label="Value" show-overflow-tooltip>
                            <template #default="scope">
                                <span>{{ scope.row.value }}</span>
                                <el-tag v-if="scope.row.encrypted" type="warning" size="small" effect="dark" style="margin-left: 5px;"><i class="fas fa-lock"></i></el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="description" label="Description" show-overflow-tooltip></el-table-column>
                        <el-table-column prop="enabled" label="Status" width="100">
                            <template #default="scope">
                                <el-tag :type="scope.row.enabled ? 'success' : 'info'">{{ scope.row.enabled ? 'Enabled' : 'Disabled' }}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="updateTime" label="Update Time" width="180">
                            <template #default="scope">{{ formatDate(scope.row.updateTime) }}</template>
                        </el-table-column>
                        <el-table-column label="Actions" width="150" fixed="right">
                            <template #default="scope">
                                <el-button size="small" @click="openEditModal(scope.row)"><i class="fas fa-pen"></i></el-button>
                                <el-button size="small" type="danger" @click="handleDelete(scope.row)"><i class="fas fa-trash"></i></el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-card>

                <el-dialog v-model="dialogVisible" title="Batch Add / Modify Configurations" width="80%">
                    <el-alert title="Changes will be saved as Drafts. Use the 'Encrypt' button to secure sensitive values." type="info" show-icon :closable="false" style="margin-bottom: 20px;"></el-alert>
                    <el-table :data="drafts" style="width: 100%">
                        <el-table-column label="Namespace" width="180">
                            <template #default="scope"><el-input v-model="scope.row.namespace" placeholder="Namespace"></el-input></template>
                        </el-table-column>
                        <el-table-column label="Key" width="180">
                            <template #default="scope"><el-input v-model="scope.row.key" placeholder="Key"></el-input></template>
                        </el-table-column>
                        <el-table-column label="Value">
                            <template #default="scope">
                                <el-input v-model="scope.row.value" placeholder="Value" @input="handleValueChange(scope.row)">
                                    <template #append>
                                        <el-button @click="encryptValue(scope.row)" title="Encrypt"><i class="fas fa-lock"></i></el-button>
                                    </template>
                                </el-input>
                                <el-tag v-if="scope.row.encrypted" type="warning" size="small" style="margin-top: 5px;"><i class="fas fa-lock"></i> Encrypted</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="Description" width="200">
                            <template #default="scope"><el-input v-model="scope.row.description" placeholder="Description"></el-input></template>
                        </el-table-column>
                        <el-table-column width="60">
                            <template #default="scope">
                                <el-button type="danger" circle size="small" @click="removeDraftRow(scope.$index)"><i class="fas fa-trash"></i></el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                    <div style="margin-top: 10px;">
                        <el-button @click="addDraftRow"><i class="fas fa-plus me-1"></i>Add Row</el-button>
                    </div>
                    <template #footer>
                        <span class="dialog-footer">
                            <el-button @click="dialogVisible = false">Cancel</el-button>
                            <el-button type="primary" @click="saveDrafts">Save to Drafts</el-button>
                        </span>
                    </template>
                </el-dialog>
            </div>
        `,
        setup() {
            const tableData = ref([]);
            const loading = ref(false);
            const keyword = ref('');
            const selectedRows = ref([]);
            const dialogVisible = ref(false);
            const drafts = ref([]);

            const fetchData = async () => {
                loading.value = true;
                try {
                    // Axios interceptor will return data directly
                    const data = await axios.get('/admin/api/config/list', { params: { keyword: keyword.value } });
                    tableData.value = data;
                } catch (error) {
                    ElMessage.error(error.message);
                } finally {
                    loading.value = false;
                }
            };

            const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleString() : '';
            const handleSelectionChange = (val) => selectedRows.value = val;

            const openAddModal = () => {
                drafts.value = [{ namespace: '', key: '', value: '', description: '', operationType: 'ADD', enabled: true, encrypted: false }];
                dialogVisible.value = true;
            };

            const openEditModal = (row) => {
                drafts.value = [{
                    configId: row.id,
                    namespace: row.namespace,
                    key: row.key,
                    value: row.value,
                    description: row.description,
                    operationType: 'UPDATE',
                    enabled: row.enabled,
                    encrypted: row.encrypted
                }];
                dialogVisible.value = true;
            };

            const addDraftRow = () => drafts.value.push({ namespace: '', key: '', value: '', description: '', operationType: 'ADD', enabled: true, encrypted: false });
            const removeDraftRow = (index) => drafts.value.splice(index, 1);
            const handleValueChange = (row) => row.encrypted = false;

            const encryptValue = async (row) => {
                if (!row.value) return ElMessage.warning('Please enter a value to encrypt');
                try {
                    const formData = new FormData();
                    formData.append('value', row.value);
                    const data = await axios.post('/admin/api/config/encrypt', formData);
                    row.value = data.encrypted;
                    row.encrypted = true;
                    ElMessage.success('Value encrypted');
                } catch (error) {
                    ElMessage.error(error.message);
                }
            };

            const saveDrafts = async () => {
                try {
                    const validDrafts = drafts.value.filter(d => d.key && d.namespace);
                    if (validDrafts.length === 0) return ElMessage.warning('Please fill in at least Namespace and Key');
                    await axios.post('/admin/api/config/saveBatch', { drafts: validDrafts });
                    ElMessage.success('Drafts saved successfully');
                    dialogVisible.value = false;
                    fetchData();
                } catch (error) {
                    ElMessage.error(error.message);
                }
            };

            const handleDelete = (row) => {
                ElMessageBox.confirm('Are you sure to delete this config?', 'Warning', { type: 'warning' }).then(async () => {
                    try {
                        await axios.post('/admin/api/config/save', {
                            configId: row.id,
                            namespace: row.namespace,
                            key: row.key,
                            value: row.value,
                            operationType: 'DELETE'
                        });
                        ElMessage.success('Delete draft created');
                    } catch (error) {
                        ElMessage.error(error.message);
                    }
                });
            };

            const batchDelete = () => {
                ElMessageBox.confirm(`Delete ${selectedRows.value.length} configs?`, 'Warning', { type: 'warning' }).then(async () => {
                    const deleteDrafts = selectedRows.value.map(row => ({
                        configId: row.id,
                        namespace: row.namespace,
                        key: row.key,
                        value: row.value,
                        operationType: 'DELETE'
                    }));
                    try {
                        await axios.post('/admin/api/config/saveBatch', { drafts: deleteDrafts });
                        ElMessage.success('Batch delete drafts created');
                    } catch (error) {
                        ElMessage.error(error.message);
                    }
                });
            };

            onMounted(() => {
                fetchData();
            });

            return {
                activeMenu,
                handleSelect,
                tableData,
                loading,
                keyword,
                fetchData,
                formatDate,
                selectedRows,
                handleSelectionChange,
                dialogVisible,
                drafts,
                openAddModal,
                openEditModal,
                addDraftRow,
                removeDraftRow,
                handleValueChange,
                encryptValue,
                saveDrafts,
                handleDelete,
                batchDelete
            };
        }
    };

    // Config Drafts Component
    const ConfigDrafts = {
        template: `
            <div>
                <div class="page-header">
                    <h2><i class="fas fa-clipboard-list me-2 text-warning"></i>Config Drafts</h2>
                    <div v-if="tableData.length > 0">
                        <el-button type="primary" @click="$router.push('/admin/config/diff')"><i class="fas fa-exchange-alt me-1"></i>Review & Publish</el-button>
                    </div>
                </div>
                <el-card>
                    <el-table :data="tableData" style="width: 100%" v-loading="loading">
                        <el-table-column prop="operationType" label="Operation" width="120">
                            <template #default="scope">
                                <el-tag :type="getOpType(scope.row.operationType)">{{ scope.row.operationType }}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="namespace" label="Namespace"><template #default="scope"><el-tag type="info">{{ scope.row.namespace }}</el-tag></template></el-table-column>
                        <el-table-column prop="key" label="Key" class-name="fw-bold"></el-table-column>
                        <el-table-column prop="value" label="Value" show-overflow-tooltip>
                            <template #default="scope">
                                <span>{{ scope.row.value }}</span>
                                <el-tag v-if="scope.row.encrypted" type="warning" size="small" effect="dark" style="margin-left: 5px;"><i class="fas fa-lock"></i></el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="updateBy" label="User" width="150"></el-table-column>
                        <el-table-column prop="updateTime" label="Time" width="180"><template #default="scope">{{ formatDate(scope.row.updateTime) }}</template></el-table-column>
                        <el-table-column label="Action" width="100" fixed="right">
                            <template #default="scope">
                                <el-button size="small" type="danger" @click="discard(scope.row.id)"><i class="fas fa-times"></i></el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                    <el-empty v-if="!loading && tableData.length === 0" description="No pending drafts"></el-empty>
                </el-card>
            </div>
        `,
        setup() {
            const tableData = ref([]);
            const loading = ref(false);
            const fetchData = async () => {
                loading.value = true;
                try {
                    const data = await axios.get('/admin/api/config/drafts');
                    tableData.value = data;
                } catch (error) { ElMessage.error(error.message); } finally { loading.value = false; }
            };
            const getOpType = (type) => type === 'ADD' ? 'success' : (type === 'DELETE' ? 'danger' : 'warning');
            const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleString() : '';
            const discard = (id) => {
                ElMessageBox.confirm('Discard this draft?', 'Warning', { type: 'warning' }).then(async () => {
                    try { await axios.get('/admin/api/config/discard/' + id); ElMessage.success('Draft discarded'); fetchData(); } catch (error) { ElMessage.error(error.message); }
                });
            };
            onMounted(() => fetchData());
            return { tableData, loading, getOpType, formatDate, discard };
        }
    };

    // Config Diff Component
    const ConfigDiff = {
        template: `
            <div>
                <div class="page-header">
                    <h2><i class="fas fa-exchange-alt me-2 text-primary"></i>Review Changes</h2>
                    <div>
                        <el-button @click="$router.push('/admin/config/drafts')">Back</el-button>
                        <el-button type="success" @click="publish" :loading="publishing"><i class="fas fa-check-circle me-1"></i>Confirm & Publish</el-button>
                    </div>
                </div>
                <div v-loading="loading">
                    <el-empty v-if="!loading && diffs.length === 0" description="No pending changes"></el-empty>
                    <div v-for="(diff, index) in diffs" :key="index" class="diff-card">
                        <div class="diff-header">
                            <div>
                                <el-tag :type="getOpType(diff.diffType)" style="margin-right: 10px;">{{ diff.diffType }}</el-tag>
                                <span style="font-weight: bold;">{{ diff.namespace }} / {{ diff.key }}</span>
                            </div>
                        </div>
                        <div class="diff-content">
                            <div class="diff-pane" :class="diff.oldValue ? 'old' : 'empty'">
                                <div class="diff-label">ORIGINAL</div>{{ diff.oldValue || '(None)' }}
                            </div>
                            <div class="diff-pane" :class="diff.newValue ? 'new' : 'empty'">
                                <div class="diff-label">NEW (DRAFT)</div>{{ diff.newValue || '(None)' }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        setup() {
            const diffs = ref([]);
            const loading = ref(false);
            const publishing = ref(false);
            const router = useRouter();
            const fetchData = async () => {
                loading.value = true;
                try { const data = await axios.get('/admin/api/config/diff'); diffs.value = data; } catch (error) { ElMessage.error(error.message); } finally { loading.value = false; }
            };
            const getOpType = (type) => type === 'ADD' ? 'success' : (type === 'DELETE' ? 'danger' : 'warning');
            const publish = () => {
                ElMessageBox.confirm('Confirm publish?', 'Warning', { type: 'success' }).then(async () => {
                    publishing.value = true;
                    try { await axios.post('/admin/api/config/publish'); ElMessage.success('Published'); router.push('/admin/config'); } catch (error) { ElMessage.error(error.message); } finally { publishing.value = false; }
                });
            };
            onMounted(() => fetchData());
            return { diffs, loading, publishing, getOpType, publish };
        }
    };

    // Config History Component
    const ConfigHistory = {
        template: `
            <div>
                <div class="page-header">
                    <h2><i class="fas fa-history me-2 text-primary"></i>Config History</h2>
                    <el-button type="warning" v-if="selectedRows.length > 0" @click="batchRollback"><i class="fas fa-undo me-1"></i>Batch Rollback</el-button>
                </div>
                <el-card>
                    <el-table :data="tableData" style="width: 100%" @selection-change="val => selectedRows = val" v-loading="loading">
                        <el-table-column type="selection" width="55"></el-table-column>
                        <el-table-column prop="version" label="Version" width="180"><template #default="scope"><el-tag type="info">{{ scope.row.version }}</el-tag></template></el-table-column>
                        <el-table-column prop="namespace" label="Namespace" width="150"></el-table-column>
                        <el-table-column prop="key" label="Key" class-name="fw-bold"></el-table-column>
                        <el-table-column prop="value" label="Value" show-overflow-tooltip>
                            <template #default="scope">
                                <span>{{ scope.row.value }}</span>
                                <el-tag v-if="scope.row.encrypted" type="warning" size="small" effect="dark" style="margin-left: 5px;"><i class="fas fa-lock"></i></el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column prop="operationType" label="Op" width="100"></el-table-column>
                        <el-table-column prop="createBy" label="User" width="120"></el-table-column>
                        <el-table-column prop="createTime" label="Time" width="180"><template #default="scope">{{ formatDate(scope.row.createTime) }}</template></el-table-column>
                        <el-table-column label="Action" width="120" fixed="right">
                            <template #default="scope">
                                <el-button size="small" type="warning" @click="rollback(scope.row.historyId)">Rollback</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-card>
            </div>
        `,
        setup() {
            const tableData = ref([]);
            const loading = ref(false);
            const selectedRows = ref([]);
            const router = useRouter();
            const fetchData = async () => {
                loading.value = true;
                try { const data = await axios.get('/admin/api/config/history'); tableData.value = data; } catch (error) { ElMessage.error(error.message); } finally { loading.value = false; }
            };
            const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleString() : '';
            const rollback = (id) => {
                ElMessageBox.confirm('Rollback to this version?', 'Warning', { type: 'warning' }).then(async () => {
                    try { await axios.post('/admin/api/config/rollback/' + id); ElMessage.success('Rollback draft created'); router.push('/admin/config/drafts'); } catch (error) { ElMessage.error(error.message); }
                });
            };
            const batchRollback = () => {
                ElMessageBox.confirm(`Rollback ${selectedRows.value.length} items?`, 'Warning').then(async () => {
                    const ids = selectedRows.value.map(row => row.historyId);
                    try { await axios.post('/admin/api/config/rollbackBatch', ids); ElMessage.success('Batch rollback drafts created'); router.push('/admin/config/drafts'); } catch (error) { ElMessage.error(error.message); }
                });
            };
            onMounted(() => fetchData());
            return { tableData, loading, selectedRows, formatDate, rollback, batchRollback };
        }
    };

    // Route List Component
    const RouteList = {
        template: `
            <div>
                <div class="page-header">
                    <h2><i class="fas fa-route me-2 text-primary"></i>Route List</h2>
                    <div class="actions">
                        <el-input v-model="keyword" placeholder="Search..." style="width: 200px; margin-right: 10px;" @keyup.enter="fetchData" clearable @clear="fetchData">
                            <template #append><el-button @click="fetchData"><i class="fas fa-search"></i></el-button></template>
                        </el-input>
                        <el-button type="primary" @click="openAddModal"><i class="fas fa-plus me-1"></i>Add Route</el-button>
                    </div>
                </div>
                <el-card>
                    <el-table :data="tableData" style="width: 100%" v-loading="loading">
                        <el-table-column prop="id" label="ID" width="150" class-name="fw-bold"></el-table-column>
                        <el-table-column prop="uri" label="URI" width="200"><template #default="scope"><el-tag type="info">{{ scope.row.uri }}</el-tag></template></el-table-column>
                        <el-table-column prop="order" label="Order" width="80"></el-table-column>
                        <el-table-column prop="description" label="Description" show-overflow-tooltip></el-table-column>
                        <el-table-column prop="enabled" label="Status" width="100">
                            <template #default="scope"><el-tag :type="scope.row.enabled ? 'success' : 'info'">{{ scope.row.enabled ? 'Enabled' : 'Disabled' }}</el-tag></template>
                        </el-table-column>
                        <el-table-column prop="updateTime" label="Update Time" width="180"><template #default="scope">{{ formatDate(scope.row.updateTime) }}</template></el-table-column>
                        <el-table-column label="Actions" width="150" fixed="right">
                            <template #default="scope">
                                <el-button size="small" @click="openEditModal(scope.row)"><i class="fas fa-pen"></i></el-button>
                                <el-button size="small" type="danger" @click="handleDelete(scope.row)"><i class="fas fa-trash"></i></el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-card>

                <el-dialog v-model="dialogVisible" :title="form.operationType === 'ADD' ? 'Add Route' : 'Modify Route'" width="60%">
                    <el-alert title="Changes will be saved as Drafts." type="info" show-icon :closable="false" style="margin-bottom: 20px;"></el-alert>
                    <el-form :model="form" label-width="120px">
                        <el-form-item label="Route ID"><el-input v-model="form.id" :disabled="form.operationType === 'UPDATE'"></el-input></el-form-item>
                        <el-form-item label="URI"><el-input v-model="form.uri" placeholder="e.g. lb://user-service"></el-input></el-form-item>
                        <el-form-item label="Order"><el-input-number v-model="form.orderNum"></el-input-number></el-form-item>
                        <el-form-item label="Description"><el-input v-model="form.description"></el-input></el-form-item>
                        <el-form-item label="Predicates"><el-input v-model="form.predicatesJson" type="textarea" :rows="4" placeholder='[{"name":"Path", "args":{"pattern":"/user/**"}}]' style="font-family: monospace;"></el-input></el-form-item>
                        <el-form-item label="Filters"><el-input v-model="form.filtersJson" type="textarea" :rows="4" placeholder='[{"name":"StripPrefix", "args":{"parts":"1"}}]' style="font-family: monospace;"></el-input></el-form-item>
                        <el-form-item label="Metadata"><el-input v-model="form.metadataJson" type="textarea" :rows="3" placeholder='{"version":"v1"}' style="font-family: monospace;"></el-input></el-form-item>
                        <el-form-item label="Enabled"><el-switch v-model="form.enabled"></el-switch></el-form-item>
                    </el-form>
                    <template #footer>
                        <span class="dialog-footer">
                            <el-button @click="dialogVisible = false">Cancel</el-button>
                            <el-button type="primary" @click="saveDraft">Save to Draft</el-button>
                        </span>
                    </template>
                </el-dialog>
            </div>
        `,
        setup() {
            const tableData = ref([]);
            const loading = ref(false);
            const keyword = ref('');
            const dialogVisible = ref(false);
            const form = reactive({ id: '', uri: '', orderNum: 0, description: '', predicatesJson: '', filtersJson: '', metadataJson: '', enabled: true, operationType: 'ADD' });
            const fetchData = async () => {
                loading.value = true;
                try { const data = await axios.get('/admin/api/route/list', { params: { keyword: keyword.value } }); tableData.value = data; } catch (error) { ElMessage.error(error.message); } finally { loading.value = false; }
            };
            const formatDate = (dateStr) => dateStr ? new Date(dateStr).toLocaleString() : '';
            const openAddModal = () => {
                Object.assign(form, { id: '', uri: '', orderNum: 0, description: '', predicatesJson: '', filtersJson: '', metadataJson: '', enabled: true, operationType: 'ADD' });
                dialogVisible.value = true;
            };
            const openEditModal = (row) => {
                Object.assign(form, {
                    id: row.id,
                    uri: row.uri,
                    orderNum: row.order,
                    description: row.description,
                    predicatesJson: JSON.stringify(row.predicates),
                    filtersJson: JSON.stringify(row.filters),
                    metadataJson: JSON.stringify(row.metadata),
                    enabled: row.enabled,
                    operationType: 'UPDATE'
                });
                dialogVisible.value = true;
            };
            const saveDraft = async () => {
                try { await axios.post('/admin/api/route/save', form); ElMessage.success('Draft saved'); dialogVisible.value = false; } catch (error) { ElMessage.error(error.message); }
            };
            const handleDelete = (row) => {
                ElMessageBox.confirm('Delete this route?', 'Warning', { type: 'warning' }).then(async () => {
                    try { await axios.post('/admin/api/route/save', { id: row.id, operationType: 'DELETE' }); ElMessage.success('Delete draft created'); } catch (error) { ElMessage.error(error.message); }
                });
            };
            onMounted(() => fetchData());
            return { tableData, loading, keyword, fetchData, formatDate, dialogVisible, form, openAddModal, openEditModal, saveDraft, handleDelete };
        }
    };

    const RouteDrafts = {
        template: `
            <div>
                <div class="page-header">
                    <h2><i class="fas fa-clipboard-list me-2 text-warning"></i>Route Drafts</h2>
                    <div v-if="tableData.length > 0"><el-button type="primary" @click="$router.push('/admin/route/diff')"><i class="fas fa-exchange-alt me-1"></i>Review & Publish</el-button></div>
                </div>
                <el-card>
                    <el-table :data="tableData" style="width: 100%" v-loading="loading">
                        <el-table-column prop="operationType" label="Operation" width="120"><template #default="scope"><el-tag :type="getOpType(scope.row.operationType)">{{ scope.row.operationType }}</el-tag></template></el-table-column>
                        <el-table-column prop="id" label="ID" class-name="fw-bold"></el-table-column>
                        <el-table-column prop="uri" label="URI"></el-table-column>
                        <el-table-column prop="updateBy" label="User" width="150"></el-table-column>
                        <el-table-column prop="updateTime" label="Time" width="180"><template #default="scope">{{ formatDate(scope.row.updateTime) }}</template></el-table-column>
                        <el-table-column label="Action" width="100" fixed="right"><template #default="scope"><el-button size="small" type="danger" @click="discard(scope.row.id)"><i class="fas fa-times"></i></el-button></template></el-table-column>
                    </el-table>
                    <el-empty v-if="!loading && tableData.length === 0" description="No pending drafts"></el-empty>
                </el-card>
            </div>
        `,
        setup() {
            const tableData = ref([]);
            const loading = ref(false);
            const fetchData = async () => { loading.value = true; try { const data = await axios.get('/admin/api/route/drafts'); tableData.value = data; } catch (e) { ElMessage.error(e.message); } finally { loading.value = false; } };
            const getOpType = (type) => type === 'ADD' ? 'success' : (type === 'DELETE' ? 'danger' : 'warning');
            const formatDate = (d) => d ? new Date(d).toLocaleString() : '';
            const discard = (id) => { ElMessageBox.confirm('Discard?', 'Warning').then(async () => { try { await axios.get('/admin/api/route/discard/' + id); ElMessage.success('Discarded'); fetchData(); } catch (e) { ElMessage.error(e.message); } }); };
            onMounted(() => fetchData());
            return { tableData, loading, getOpType, formatDate, discard };
        }
    };

    const RouteDiff = {
        template: `
            <div>
                <div class="page-header">
                    <h2><i class="fas fa-exchange-alt me-2 text-primary"></i>Review Route Changes</h2>
                    <div><el-button @click="$router.push('/admin/route/drafts')">Back</el-button><el-button type="success" @click="publish" :loading="publishing"><i class="fas fa-check-circle me-1"></i>Confirm & Publish</el-button></div>
                </div>
                <div v-loading="loading">
                    <el-empty v-if="!loading && diffs.length === 0" description="No pending changes"></el-empty>
                    <div v-for="(diff, index) in diffs" :key="index" class="diff-card">
                        <div class="diff-header"><div><el-tag :type="getOpType(diff.diffType)" style="margin-right: 10px;">{{ diff.diffType }}</el-tag><span style="font-weight: bold;">{{ diff.key }}</span></div></div>
                        <div class="diff-content">
                            <div class="diff-pane" :class="diff.oldValue ? 'old' : 'empty'"><div class="diff-label">ORIGINAL</div>{{ diff.oldValue || '(None)' }}</div>
                            <div class="diff-pane" :class="diff.newValue ? 'new' : 'empty'"><div class="diff-label">NEW (DRAFT)</div>{{ diff.newValue || '(None)' }}</div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        setup() {
            const diffs = ref([]);
            const loading = ref(false);
            const publishing = ref(false);
            const router = useRouter();
            const fetchData = async () => { loading.value = true; try { const data = await axios.get('/admin/api/route/diff'); diffs.value = data; } catch (e) { ElMessage.error(e.message); } finally { loading.value = false; } };
            const getOpType = (type) => type === 'ADD' ? 'success' : (type === 'DELETE' ? 'danger' : 'warning');
            const publish = () => { ElMessageBox.confirm('Publish?', 'Warning', { type: 'success' }).then(async () => { publishing.value = true; try { await axios.post('/admin/api/route/publish'); ElMessage.success('Published'); router.push('/admin/route'); } catch (e) { ElMessage.error(e.message); } finally { publishing.value = false; } }); };
            onMounted(() => fetchData());
            return { diffs, loading, publishing, getOpType, publish };
        }
    };

    const RouteHistory = {
        template: `
            <div>
                <div class="page-header"><h2><i class="fas fa-history me-2 text-primary"></i>Route History</h2><el-button type="warning" v-if="selectedRows.length > 0" @click="batchRollback"><i class="fas fa-undo me-1"></i>Batch Rollback</el-button></div>
                <el-card>
                    <el-table :data="tableData" style="width: 100%" @selection-change="val => selectedRows = val" v-loading="loading">
                        <el-table-column type="selection" width="55"></el-table-column>
                        <el-table-column prop="version" label="Version" width="180"><template #default="scope"><el-tag type="info">{{ scope.row.version }}</el-tag></template></el-table-column>
                        <el-table-column prop="routeId" label="ID" class-name="fw-bold"></el-table-column>
                        <el-table-column prop="uri" label="URI"></el-table-column>
                        <el-table-column prop="operationType" label="Op" width="100"></el-table-column>
                        <el-table-column prop="createBy" label="User" width="120"></el-table-column>
                        <el-table-column prop="createTime" label="Time" width="180"><template #default="scope">{{ formatDate(scope.row.createTime) }}</template></el-table-column>
                        <el-table-column label="Action" width="120" fixed="right"><template #default="scope"><el-button size="small" type="warning" @click="rollback(scope.row.historyId)">Rollback</el-button></template></el-table-column>
                    </el-table>
                </el-card>
            </div>
        `,
        setup() {
            const tableData = ref([]);
            const loading = ref(false);
            const selectedRows = ref([]);
            const router = useRouter();
            const fetchData = async () => { loading.value = true; try { const data = await axios.get('/admin/api/route/history'); tableData.value = data; } catch (e) { ElMessage.error(e.message); } finally { loading.value = false; } };
            const formatDate = (d) => d ? new Date(d).toLocaleString() : '';
            const rollback = (id) => {
                ElMessageBox.confirm('Rollback?', 'Warning').then(async () => {
                    try { await axios.post('/admin/api/route/rollback/' + id); ElMessage.success('Rollback draft created'); router.push('/admin/route/drafts'); } catch (e) { ElMessage.error(e.message); }
                });
            };
            const batchRollback = () => {
                ElMessageBox.confirm(`Rollback ${selectedRows.value.length} items?`, 'Warning').then(async () => {
                    const ids = selectedRows.value.map(r => r.historyId);
                    try { await axios.post('/admin/api/route/rollbackBatch', ids); ElMessage.success('Batch rollback drafts created'); router.push('/admin/route/drafts'); } catch (e) { ElMessage.error(e.message); }
                });
            };
            onMounted(() => fetchData());
            return { tableData, loading, selectedRows, formatDate, rollback, batchRollback };
        }
    };

    // --- Router ---
    const routes = [
        { path: '/admin/config', component: ConfigList },
        { path: '/admin/config/drafts', component: ConfigDrafts },
        { path: '/admin/config/diff', component: ConfigDiff },
        { path: '/admin/config/history', component: ConfigHistory },
        { path: '/admin/route', component: RouteList },
        { path: '/admin/route/drafts', component: RouteDrafts },
        { path: '/admin/route/diff', component: RouteDiff },
        { path: '/admin/route/history', component: RouteHistory },
        { path: '/:pathMatch(.*)*', redirect: '/admin/config' }
    ];

    const router = createRouter({
        history: createWebHistory(),
        routes,
    });

    const app = createApp({
        setup() {
            const activeRoute = computed(() => router.currentRoute.value.path);
            return { activeRoute };
        }
    });

    app.use(ElementPlus);
    app.use(router);
    app.mount('#app');
</script>

</body>
</html>
